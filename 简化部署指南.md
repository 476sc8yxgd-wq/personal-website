# 🚀 后端超简化部署指南

## ⚡ 快速部署（5 分钟）

### 步骤 1：登录宝塔面板

- 地址：https://43.138.3.207:20794/8ff1df99
- 用户名：`ede6tf5z`
- 密码：您的宝塔面板密码

### 步骤 2：上传必要文件

在宝塔面板的文件管理中：

1. **导航到：** `/var/www/personal-website`
2. **上传并替换以下文件：**

   从项目根目录上传：
   - ✅ `Dockerfile`
   - ✅ `docker-compose.yml`

   从 `backend/` 目录上传：
   - ✅ `backend/package.json`
   - ✅ `backend/tsconfig.json`
   - ✅ `backend/src/server.ts`
   - ✅ `backend/src/config/supabase.ts`

3. **上传方式：**
   - 压缩整个 `backend` 目录为 `backend.zip`
   - 上传后在服务器解压
   - 或者直接拖拽上传

### 步骤 3：在宝塔终端执行命令

在宝塔面板左侧菜单找到 **"终端"**，点击进入，然后执行以下命令：

```bash
# 进入项目目录
cd /var/www/personal-website

# 停止并清理旧容器
docker-compose down

# 清理旧镜像
docker image prune -f

# 构建新镜像（2-5 分钟）
docker-compose build --no-cache

# 启动容器
docker-compose up -d

# 查看日志（确认是否成功）
docker-compose logs -f
```

### 步骤 4：验证部署

#### 查看容器状态：

```bash
docker ps
```

应该看到：
```
personal_website   Up   0.0.0.0:8008->3000/tcp
```

#### 测试后端 API：

```bash
curl http://localhost:3000/api/health
```

应该返回：
```json
{"status":"Server is running","timestamp":"..."}
```

#### 访问网站：

- **前端:** http://43.138.3.207:8008
- **后端:** http://43.138.3.207:3000
- **健康检查:** http://43.138.3.207:3000/health

---

## 📋 文件清单

### 需要上传的文件（共 6 个）：

```
Dockerfile (1.08 KB)
docker-compose.yml (679 B)
backend/package.json (928 B)
backend/tsconfig.json (383 B)
backend/src/server.ts (1.75 KB)
backend/src/config/supabase.ts (491 B)
```

### 服务器目录结构（部署后）：

```
/var/www/personal-website/
├── Dockerfile (新）
├── docker-compose.yml (新）
├── backend/
│   ├── package.json
│   ├── tsconfig.json
│   └── src/
│       ├── server.ts
│       └── config/
│           └── supabase.ts
├── public/ (前端文件，已上传）
└── logs/ (日志目录）
```

---

## ⚠️ 重要提示

### Dockerfile 已在服务器上创建

我已经通过服务器命令创建了：
- ✅ `Dockerfile`
- ✅ `docker-compose.yml`

**您只需要上传 `backend/` 目录！**

### 自动化脚本

我还创建了自动化部署脚本：

**位置：** `C:\Users\28945\Desktop\个人网站重制版\deploy-backend-full.ps1`

**使用方法：**
1. 右键点击 → "使用 PowerShell 运行"
2. 输入服务器密码

这个脚本会自动：
- ✅ 上传所有文件
- ✅ 在服务器构建
- ✅ 启动容器
- ✅ 验证部署

---

## 🔧 常用命令

### 查看容器状态

```bash
docker ps
```

### 查看容器日志

```bash
docker-compose logs -f
```

### 重启服务

```bash
cd /var/www/personal-website
docker-compose restart
```

### 停止服务

```bash
docker-compose stop
```

### 启动服务

```bash
docker-compose start
```

### 重建服务

```bash
docker-compose up -d --build
```

### 进入容器

```bash
docker exec -it personal_website sh
```

---

## ❓ 常见问题

### Q1: docker-compose build 失败

**错误：** `npm install failed`

**解决：**
```bash
# 清理缓存
docker system prune -a

# 重新构建
docker-compose build --no-cache
```

### Q2: 容器启动失败

**错误：** `Container exited with code 1`

**解决：**
```bash
# 查看日志
docker-compose logs

# 检查文件是否存在
ls -la backend/

# 检查配置
docker-compose config
```

### Q3: 端口被占用

**错误：** `bind: address already in use`

**解决：**
```bash
# 杀死占用端口的进程
lsof -ti:3000 | xargs kill -9

# 重启容器
docker-compose up -d
```

### Q4: 前端无法连接后端

**检查：**
```bash
# 检查容器状态
docker ps

# 检查端口映射
docker port personal_website

# 测试后端
curl http://localhost:3000/api/health
```

---

## ✅ 部署检查清单

部署完成后，请确认：

- [ ] `Dockerfile` 已更新
- [ ] `docker-compose.yml` 已更新
- [ ] `backend/package.json` 已上传
- [ ] `backend/tsconfig.json` 已上传
- [ ] `backend/src/server.ts` 已上传
- [ ] `backend/src/config/supabase.ts` 已上传
- [ ] 容器已构建
- [ ] 容器正在运行
- [ ] 端口 3000 正在监听
- [ ] 端口 8008 正在监听
- [ ] 后端 API 正常响应
- [ ] 前端可以访问
- [ ] 健康检查通过

---

## 🎯 预期结果

### 容器信息：

```
NAME               STATUS         PORTS
personal_website   Up 2 minutes   0.0.0.0:8008->3000/tcp, :::8008->8008/tcp
```

### API 响应：

```json
{
  "status": "Server is running",
  "timestamp": "2025-12-26T02:30:00.000Z"
}
```

### 网站访问：

- ✅ http://43.138.3.207:8008 - 前端界面
- ✅ http://43.138.3.207:3000/api/health - 后端健康检查
- ✅ http://43.138.3.207:3000/api/blogs - 博客列表
- ✅ http://43.138.3.207:3000/api/qa - 问答列表

---

## 📞 需要帮助？

如果遇到问题，请检查：

1. **宝塔面板日志** - 查看服务器日志
2. **Docker 容器日志** - `docker-compose logs`
3. **浏览器控制台** - 查看前端错误

---

**预计完成时间：** 5-10 分钟
**最后更新：** 2025-12-26

**开始部署：**
1. 登录宝塔面板
2. 上传 backend 目录
3. 执行构建命令
4. 验证部署成功

🚀 **祝您部署顺利！**
