# 宝塔面板部署指南

## 方案一：使用PM2管理器部署（推荐）

### 1. 服务器准备

#### 1.1 安装宝塔面板
如果服务器还未安装宝塔面板，请先安装：

**CentOS:**
```bash
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```

**Ubuntu/Debian:**
```bash
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

#### 1.2 登录宝塔面板
安装完成后，使用外网面板地址登录宝塔面板。

### 2. 安装必要软件

#### 2.1 安装Node.js管理器
1. 登录宝塔面板
2. 进入【软件商店】
3. 搜索并安装【PM2管理器】（会自动安装Node.js）

#### 2.2 安装Node.js版本
1. 进入【PM2管理器】设置
2. 选择Node.js版本（建议18.x或以上）
3. 点击安装

### 3. 上传项目文件

#### 3.1 方式一：使用宝塔文件管理器上传
1. 进入【文件】菜单
2. 进入网站根目录（如：`/www/wwwroot/`）
3. 新建文件夹 `my-website`
4. 选中 `my-website` 文件夹
5. 点击【上传】，上传本地项目文件

#### 3.2 方式二：使用Git拉取（推荐）
1. 如果项目在Git仓库，在宝塔【文件】中打开终端
2. 执行以下命令：
```bash
cd /www/wwwroot/
git clone [你的Git仓库地址] my-website
```

### 4. 安装依赖并构建项目

#### 4.1 安装后端依赖
在宝塔【文件】中打开终端，或使用SSH连接服务器：
```bash
cd /www/wwwroot/my-website/backend
npm install
npm run build
```

#### 4.2 构建前端
```bash
cd /www/wwwroot/my-website/frontend
npm install
npm run build
```

构建完成后，前端文件会在 `frontend/dist` 目录下。

#### 4.3 复制前端文件到后端public目录
```bash
cd /www/wwwroot/my-website
mkdir -p backend/public
cp -r frontend/dist/* backend/public/
```

### 5. 配置环境变量

#### 5.1 创建.env文件
在 `backend` 目录下创建 `.env` 文件：

```bash
cd /www/wwwroot/my-website/backend
nano .env
```

#### 5.2 配置环境变量
复制以下内容（根据你的实际情况修改）：

```env
NODE_ENV=production
PORT=3001

# Supabase配置（从你的Supabase项目获取）
SUPABASE_URL=https://assfhuxuglbootvpigeu.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFzc2ZodXh1Z2xib290dnBpZ2V1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzOTIzNjUsImV4cCI6MjA4MTk2ODM2NX0.bTWc11pGIvy9Fz5O_9Gch3ZJEVP2pdKlTT5N79gcWCA

# JWT配置
JWT_SECRET=your_jwt_secret_key_here_please_change_this
JWT_EXPIRES_IN=7d
```

保存并退出（nano: Ctrl+X, Y, Enter）

### 6. 在PM2管理器中添加项目

#### 6.1 添加项目
1. 进入【PM2管理器】
2. 点击【添加项目】
3. 填写以下信息：
   - **项目名称**: `my-website`
   - **运行目录**: `/www/wwwroot/my-website/backend`
   - **启动文件**: `dist/server.js`（TypeScript编译后的文件）
   - **端口**: `3001`
   - **Node版本**: 选择你安装的Node版本

#### 6.2 保存并启动
点击【提交】保存配置，项目会自动启动。

### 7. 创建网站并配置反向代理

#### 7.1 创建网站
1. 进入【网站】菜单
2. 点击【添加站点】
3. 填写以下信息：
   - **域名**: 输入你的域名（如：`www.yourdomain.com`）
   - **PHP版本**: 纯静态
   - **根目录**: `/www/wwwroot/my-website/backend/public`

#### 7.2 配置反向代理
1. 找到刚创建的网站，点击【设置】
2. 选择【反向代理】选项
3. 点击【添加反向代理】
4. 填写以下信息：
   - **代理名称**: `Node.js应用`
   - **目标URL**: `http://127.0.0.1:3001`
   - **发送域名**: `$host`
5. 点击【提交】

#### 7.3 配置Location规则（可选）
确保所有请求都转发到后端，在【配置文件】中添加：

```nginx
location / {
    proxy_pass http://127.0.0.1:3001;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
}
```

### 8. 开放端口

#### 8.1 在宝塔面板开放端口
1. 进入【安全】菜单
2. 添加端口 `3001`（TCP）

#### 8.2 在云服务器控制台开放端口
根据你的云服务商（腾讯云、阿里云等），在控制台的安全组中开放 `3001` 端口。

### 9. 配置SSL证书（推荐）

#### 9.1 申请Let's Encrypt证书
1. 在网站设置中点击【SSL】
2. 选择【Let's Encrypt】
3. 勾选你的域名
4. 点击【申请】

#### 9.2 强制HTTPS
申请成功后，勾选【强制HTTPS】

### 10. 验证部署

#### 10.1 检查PM2项目状态
在【PM2管理器】中确认项目状态为【运行中】

#### 10.2 检查网站访问
在浏览器中访问你的域名，检查网站是否正常运行。

#### 10.3 查看日志
如果遇到问题，在PM2管理器中点击【日志】查看运行日志。

## 更新部署流程

### 方式一：使用宝塔面板更新

1. **拉取最新代码**（如果使用Git）
```bash
cd /www/wwwroot/my-website
git pull
```

2. **重新构建前端**
```bash
cd /www/wwwroot/my-website/frontend
npm install
npm run build
```

3. **重新构建后端**
```bash
cd /www/wwwroot/my-website/backend
npm install
npm run build
```

4. **复制前端文件**
```bash
cd /www/wwwroot/my-website
cp -r frontend/dist/* backend/public/
```

5. **重启PM2项目**
在宝塔面板的【PM2管理器】中，点击项目右侧的【重启】按钮。

### 方式二：使用自动化脚本

创建更新脚本 `update.sh`：
```bash
#!/bin/bash

echo "开始更新项目..."

# 拉取最新代码
cd /www/wwwroot/my-website
git pull

# 构建前端
echo "构建前端..."
cd frontend
npm install
npm run build

# 构建后端
echo "构建后端..."
cd ../backend
npm install
npm run build

# 复制前端文件
echo "复制前端文件..."
cd ..
cp -r frontend/dist/* backend/public/

# 重启PM2项目
echo "重启项目..."
pm2 restart my-website

echo "更新完成！"
```

设置执行权限并运行：
```bash
chmod +x update.sh
./update.sh
```

## 方案二：使用Docker管理器部署

如果服务器已安装Docker，也可以使用宝塔的Docker管理器：

### 1. 安装Docker管理器
1. 在【软件商店】搜索【Docker管理器】
2. 安装Docker管理器

### 2. 上传项目文件
同方案一的步骤3

### 3. 修改docker-compose.yml
确保配置正确，特别是端口映射：
```yaml
ports:
  - "3001:3001"  # 改为3001端口，避免冲突
```

### 4. 构建并启动容器
1. 进入【Docker管理器】
2. 选择【镜像构建】
3. 上传docker-compose.yml和Dockerfile
4. 点击【构建并启动】

### 5. 配置反向代理
同方案一的步骤7

## 常见问题排查

### 1. 网站无法访问
- 检查PM2项目是否运行
- 检查端口是否开放
- 检查防火墙设置
- 查看PM2日志

### 2. 前端404
- 确认frontend/dist目录存在
- 确认文件已复制到backend/public
- 检查server.ts中的静态文件配置

### 3. API请求失败
- 检查.env文件配置
- 确认Supabase连接正常
- 查看后端日志

### 4. 更新后仍显示旧内容
- 清除浏览器缓存
- 清除CDN缓存（如果使用了CDN）
- 确认前端文件已正确复制
- 重启PM2项目

## 性能优化建议

1. **开启Gzip压缩**
在Nginx配置中添加：
```nginx
gzip on;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
```

2. **配置缓存**
```nginx
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 7d;
    add_header Cache-Control "public, immutable";
}
```

3. **监控服务**
在PM2管理器中设置监控告警

## 备份策略

1. **数据库备份**: 定期导出Supabase数据
2. **文件备份**: 使用宝塔的【计划任务】定期备份项目文件
3. **配置备份**: 导出nginx配置和环境变量

## 安全建议

1. 定期更新系统和软件
2. 使用强密码
3. 开启防火墙
4. 定期查看日志
5. 使用HTTPS

---

**注意事项:**
- 首次部署建议先在测试环境验证
- 生产环境部署前请备份重要数据
- 确保Supabase数据库已正确配置
- 定期检查和更新依赖包
